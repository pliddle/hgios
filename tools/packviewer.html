<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evidence Pack Viewer</title>

    <!--
      Loading both data sources.
    -->
    <script src="tools/evidencepackdata.js"></script>
    <script src="tools/data.js"></script> <!-- This is the new file -->

    <!--
      Added 'marked.js' library to convert Markdown to HTML
    -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* --- Base & Typography --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f9f9f9;
            color: #333;
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        /* --- Error Banner --- */
        #error-banner {
            display: none; /* Hidden by default */
            padding: 15px;
            background-color: #d9534f; /* Red */
            color: white;
            font-weight: bold;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }

        /* --- Header Styling --- */
        .header-container {
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-container img {
            height: 60px;
            width: auto; /* Maintain aspect ratio */
        }

        h1 {
            color: #1a1a1a;
            font-size: 2.2em;
            text-align: center;
            border-bottom: 2px solid #005a9c; /* School colour */
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        h2 {
            color: #005a9c; /* School colour */
            font-size: 1.6em;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
            margin-top: 40px;
        }
        
        h3 {
            color: #333;
            font-size: 1.25em;
            margin-top: 25px;
        }

        p, ul {
            font-size: 1.05em;
            margin-bottom: 15px;
        }
        
        /* --- Rich text content styling --- */
        .text-content p {
            margin-top: 0;
            margin-bottom: 1em;
        }
        .text-content ul, .text-content ol {
            margin-bottom: 1em;
            padding-left: 30px;
        }
        .text-content li {
            margin-bottom: 0.5em;
        }

        /* --- Metadata Header --- */
        .pack-meta {
            display: flex;
            flex-wrap: wrap; /* Allows stacking on small screens */
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            padding: 15px;
            background-color: #fdfdfd;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        /* --- QI Labels (HGIOS Colours) --- */
        .qi-labels {
            flex: 2; /* Give more space to labels */
            min-width: 300px;
        }

        .qi-label {
            display: inline-block;
            padding: 8px 15px;
            border-radius: 20px; /* "Pill" shape */
            font-size: 0.9em;
            font-weight: bold;
            color: #fff;
            margin-right: 10px;
            margin-bottom: 5px; /* For wrapping */
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .qi-label:empty {
            display: none;
        }

        .qi-primary {
            background-color: #005a9c; /* HGIOS Leadership Blue */
        }

        .qi-secondary {
            background-color: #008a00; /* HGIOS Learning Green */
        }

        /* --- HGIOS 6-Point Scale --- */
        .impact-score {
            flex: 1;
            min-width: 220px; /* Adjusted width */
            text-align: right;
        }
        
        .impact-score strong {
            display: block;
            font-size: 0.9em;
            color: #555;
            margin-bottom: 5px;
            text-transform: uppercase;
            font-weight: bold;
        }

        .impact-meter {
            display: flex;
            gap: 5px;
            justify-content: flex-end; /* Align to the right */
        }

        .impact-block {
            width: 30px; /* Adjusted for 6 blocks */
            height: 15px;
            border-radius: 3px;
            background-color: #e0e0e0; /* Default "off" state */
            border: 1px solid #ccc;
        }

        /* HGIOS Progressive Grade Colours */
        .hgios-1-unsatisfactory { background-color: #d9534f; border-color: #b0413e; } /* Red */
        .hgios-2-weak { background-color: #E67E22; border-color: #C0392B; } /* Orange */
        .hgios-3-satisfactory { background-color: #f7d94c; border-color: #c08a3e; } /* Yellow */
        .hgios-4-good { background-color: #5cb85c; border-color: #4a944a; } /* Green */
        .hgios-5-verygood { background-color: #008a00; border-color: #006b00; } /* Strong Green */
        .hgios-6-excellent { background-color: #005a9c; border-color: #004475; } /* Strong Blue */


        /* --- Section Styling --- */
        section {
            margin-bottom: 30px;
        }

        /* --- Quantitative Boxes --- */
        .quant-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .quant-box {
            background-color: #005a9c; /* Main accent color (Blue) */
            color: #ffffff;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.1em;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        /* Specific style for impact boxes */
        .impact-box {
            background-color: #008a00; /* Impact color (Green) */
        }
        
        /* Qualitative Speech Bubbles */
        .qual-container {
            margin-top: 20px;
        }

        .speech-bubble {
            background: #f4f8fb; /* Light blue tint */
            border-left: 5px solid #005a9c; /* Main accent color */
            padding: 15px 20px;
            margin-bottom: 15px;
            border-radius: 0 5px 5px 0;
            font-style: italic;
            font-size: 1.05em;
            position: relative;
        }

        .speech-bubble::before {
            content: '“';
            font-size: 3em;
            color: #005a9c;
            opacity: 0.2;
            position: absolute;
            top: -10px;
            left: 5px;
        }
        
        /* --- UPDATED: Visual Evidence Grid --- */
        #visual-evidence {
            display: none; /* Hidden by default, shown by JS */
        }
        .visual-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .visual-card {
            display: block;
            background-color: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
	    text-align: center;
            text-decoration: none;
            color: #333;
            transition: all 0.2s ease;
            overflow: hidden; /* Keeps rounded corners */
        }
        .visual-card:hover {
            border-color: #005a9c;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .visual-card-img {
            height: 150px;
            object-fit: cover;
            display: block;
            background-color: #f4f8fb;
            color: #777;
            font-size: 12px;
            text-align: center;
        }
        .visual-card-title {
            display: block;
            padding: 10px 15px;
            font-size: 0.9em;
            font-weight: 500;
            text-align: center;
            background-color: #fdfdfd;
            border-top: 1px solid #eee;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* --- Evidence Table Styles (to match library) --- */
        .evidence-table-container {
            overflow-x: auto;
            background-color: #fff; /* Added */
            padding: 15px; /* Added */
            border-radius: 8px; /* Added */
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); /* Added */
        }
        
        .evidence-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px; /* Reduced */
            margin-top: 0; /* Adjusted */
        }
        .evidence-table th, .evidence-table td {
            padding: 8px 10px; /* Reduced */
            text-align: left;
            border-bottom: 1px solid #ddd;
            word-break: break-word;
        }
        .evidence-table th {
            background-color: #f9f9f9;
            font-weight: 600;
            color: #333;
        }
        .evidence-table tr:hover {
            background-color: #f4f8fb;
        }
        .evidence-table td a {
            font-weight: 600;
            color: #005a9c;
            text-decoration: none;
        }
        .evidence-table td a:hover {
            text-decoration: underline;
        }
        /* Column widths */
        .evidence-table th:nth-child(1) { width: 25%; } /* Name */
        .evidence-table th:nth-child(2) { width: 10%; } /* QIs */
        .evidence-table th:nth-child(3) { width: 15%; } /* Tags */
        .evidence-table th:nth-child(4) { width: 30%; } /* Description */
        .evidence-table th:nth-child(5) { width: 10%; } /* Session */
        .evidence-table th:nth-child(6) { width: 10%; } /* Status */
        
        /* --- Table QI Label Style (Copied from library) --- */
        .table-qi-label {
            display: inline-block;
            padding: 3px 10px; 
            font-size: 11px; 
            font-weight: bold;
            color: #fff;
            background-color: #005a9c; /* HGIOS Blue */
            border-radius: 15px;
            margin-bottom: 3px; 
            margin-right: 3px;
            cursor: default; /* Make tooltip cursor normal */
        }

        
        /* --- Print Button --- */
        @media print {
            body {
                background-color: #fff;
                box-shadow: none;
                margin: 0;
                padding: 0;
            }
            .container {
                box-shadow: none;
                margin: 0;
                max-width: 100%;
            }
            .print-button, .header-container, #error-banner { /* Hide header and banner on print */
                display: none;
            }
            h1 {
                font-size: 2em;
            }
        }

        .print-button {
            display: block;
            width: 100%;
            padding: 15px;
            background-color: #005a9c;
            color: #fff;
            text-align: center;
            text-decoration: none;
            font-size: 1.2em;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
        }
        .print-button:hover {
            background-color: #004475;
        }

    </style>
</head>
<body>

    <div class="container">
        
        <!-- =======================
             ERROR BANNER
        ======================== -->
        <div id="error-banner"></div>

        <!-- =======================
             HEADER
        ======================== -->
        <div class="header-container">
            <img src="image/badge.png" alt="School Logo" class="header-image" onerror="this.src='https://placehold.co/150x60/eee/ccc?text=School+Logo'" >
            <img src="image/values.png" alt="Council Logo" class="header-image" onerror="this.src='https://placehold.co/150x60/eee/ccc?text=Council+Logo'">
        </div>


        <!-- =======================
             REST OF PAGE
        ======================== -->
        
        <h1 id="pack-title">Loading...</h1>

        <div class="pack-meta">
            <div class="qi-labels">
                <span class="qi-label qi-primary" id="primary-qi"></span>
                <span class="qi-label qi-secondary" id="secondary-qi"></span>
            </div>
            <div class="impact-score">
                <strong id="hgios-rating-text"></strong>
                <div class="impact-meter" id="hgios-meter">
                    <!-- This will be generated by JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- =======================
             NEW: VISUAL EVIDENCE
        ======================== -->
        <section id="visual-evidence">
            <h2>Visual Evidence</h2>
            <div class="visual-grid" id="visual-evidence-grid">
                <!-- This will be populated by JavaScript -->
            </div>
        </section>

        <section id="what">
            <h2>What: Our Practice & Evidence</h2>
            <!-- This div will be populated with formatted text -->
            <div id="what-text" class="text-content"></div> 
            
            <h3>Participation Summary</h3>
            <div class="quant-grid" id="participation-grid"></div>
        </section>

        <section id="so-what">
            <h2>So What: The Impact & Outcomes</h2>
            <!-- This div will be populated with formatted text -->
            <div id="so-what-text" class="text-content"></div>
            
            <h3>Quantitative Summary (Impact)</h3>
            <div class="quant-grid" id="impact-grid"></div>
            
            <h3>Qualitative Summary</h3>
            <div class="qual-container" id="qualitative-bubbles"></div>
        </section>

        <section id="what-now">
            <h2>What Now: The Next Steps</h2>
            <!-- This div will be populated with formatted text -->
            <div id="what-now-text" class="text-content"></div>
        </section>

        <!-- =======================
             EVIDENCE SECTION
        ======================== -->
        <section id="evidence">
            <h2>Collated Evidence Files</h2>
            <p>The following files from the Evidence Library are tagged with this Evidence Pack:</p>
            <div class="evidence-table-container">
                <table class="evidence-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>QIs</th>
                            <th>Tags</th>
                            <th>Description</th>
                            <th>Session(s)</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="pack-evidence-table-body">
                        <!-- This will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </section>


        <button class="print-button" onclick="window.print()">Print / Save as PDF</button>
    </div>

    <!-- =======================
         JAVASCRIPT LOGIC
    ======================== -->
    <script>
        
        // --- DATA IS NOW LOADED EXTERNALLY ---
        
        // --- HGIOS LOOKUP TABLES ---
        const hgiosText = {
            1: "Unsatisfactory",
            2: "Weak",
            3: "Satisfactory",
            4: "Good",
            5: "Very Good",
            6: "Excellent"
        };

        const hgiosClasses = [
            "hgios-1-unsatisfactory",
            "hgios-2-weak",
            "hgios-3-satisfactory",
            "hgios-4-good",
            "hgios-5-verygood",
            "hgios-6-excellent"
        ];
        
        // --- HELPER FUNCTIONS ---

        /**
         * Helper to format newlines AND render markdown
         */
        function formatMarkdown(text) {
            if (!text) return "";
            // Use marked.js to convert markdown, which also handles newlines correctly
            return marked.parse(text, { breaks: true }); // 'breaks: true' turns newlines into <br>
        }

        function buildHgiosMeter(score) {
            let meterHtml = "";
            for (let i = 0; i < 6; i++) {
                if (i < score) {
                    meterHtml += `<span class="impact-block ${hgiosClasses[i]}"></span>`;
                } else {
                    meterHtml += `<span class="impact-block"></span>`;
                }
            }
            return meterHtml;
        }

        function buildHtmlList(items, itemType) {
            let html = "";
            if (!items || items.length === 0) return ""; 

            switch (itemType) {
                case 'quant-box':
                    items.forEach(item => {
                        if(item) html += `<div class="quant-box">${item}</div>`;
                    });
                    break;
                case 'impact-box': 
                     items.forEach(item => {
                        if(item) html += `<div class="quant-box impact-box">${item}</div>`;
                    });
                    break;
                case 'speech-bubble':
                    items.forEach(item => {
                        if(item) html += `<div class="speech-bubble">${formatMarkdown(item)}</div>`; // Use markdown
                    });
                    break;
            }
            return html;
        }
        
        function setTextOrHide(element, text) {
            if (element) {
                if (text && text.trim() !== "") {
                    element.textContent = text;
                    element.style.display = 'inline-block';
                } else {
                    element.style.display = 'none';
                }
            }
        }
        
        function formatAndSetText(elementId, text) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = formatMarkdown(text);
            }
        }

        // --- Function to populate the evidence file table ---
        function populateEvidenceTable(packTitle, allFiles) {
            const tableBody = document.getElementById('pack-evidence-table-body');
            if (!tableBody) return;

            // Find all files that match the pack title
            const matchingFiles = allFiles.filter(file => 
                file["Evidence Pack Name"] === packTitle &&
                (!file.ItemType || file.ItemType.toLowerCase() !== 'folder') &&
                (file.QIs && file.QIs.trim() !== '') // Also filter items with no QI
            );

            if (matchingFiles.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6">No associated files found in the library.</td></tr>';
                return;
            }

            let tableHtml = "";
            matchingFiles.forEach(item => {
                // --- Re-using the same QI label logic from the library page ---
                let qiHtml = 'N/A';
                if (item.QIs) {
                    const qis = item.QIs.split(';')
                                      .map(qi => qi.replace(/#/g, '').trim())
                                      .filter(qi => qi); 
                    
                    if (qis.length > 0) {
                        qiHtml = qis.map(qi => {
                            const qiCodeMatch = qi.match(/^([0-9.]+)/); 
                            const qiCode = qiCodeMatch ? qiCodeMatch[1] : qi;
                            return `<span class="table-qi-label" title="${qi}">${qiCode}</span>`; 
                        }).join(' ');
                    }
                }

                const cleanSessions = item.Session ? item.Session.replace(/#/g, '') : 'N/A';
                
                const formattedDesc = formatMarkdown(item.EvidenceDescription || 'N/A');

                tableHtml += `
                    <tr>
                        <td><a href="${item.Link}" target="_blank">${item.Name}</a></td>
                        <td>${qiHtml}</td>
                        <td>${item.Tags || 'N/A'}</td>
                        <td>${formattedDesc}</td> <!-- Use formatted description -->
                        <td>${cleanSessions}</td>
                        <td>${item.Status || 'N/A'}</td>
                    </tr>
                `;
            });
            tableBody.innerHTML = tableHtml;
        }
        
        // --- UPDATED: Function to populate the visual evidence grid ---
        function populateVisualEvidence(packTitle, allFiles) {
            const container = document.getElementById('visual-evidence-grid');
            const section = document.getElementById('visual-evidence');
            const imageExtensions = ['.png', '.jpg', '.jpeg', '.gif', '.bmp', '.svg'];

            if (!container || !section) return;

            const matchingImages = allFiles.filter(file => {
                const nameLower = file.Name.toLowerCase();
                const isImage = imageExtensions.some(ext => nameLower.endsWith(ext));
                return file["Evidence Pack Name"] === packTitle && isImage &&
                       (!file.ItemType || file.ItemType.toLowerCase() !== 'folder');
            });

            if (matchingImages.length === 0) {
                section.style.display = 'none'; // Hide the whole section
                return;
            }
            
            // If we found images, show the section
            section.style.display = 'block';

            let html = "";
            matchingImages.forEach(item => {
                // Create the placeholder text
                const placeholderText = 'Please log in to%0ASharePoint%0Ato view image';
                const placeholderUrl = `https://placehold.co/300x200/f4f8fb/777?text=${placeholderText}`;
                
                // Create the onerror attribute.
                // this.onerror=null prevents an infinite loop if the placeholder fails
                const onErrorScript = `this.src='${placeholderUrl}'; this.onerror=null;`;

                html += `
                    <a href="${item.Link}" target="_blank" class="visual-card">
                        <img src="${item.Link}" alt="${item.Name}" class="visual-card-img" onerror="${onErrorScript}">
                        <span class="visual-card-title">${item.Name}</span>
                    </a>
                `;
            });
            container.innerHTML = html;
        }


        // --- MAIN LOAD FUNCTION ---
        window.onload = function() {
            
            // 1. Get index from URL (e.g., ?index=1)
            const urlParams = new URLSearchParams(window.location.search);
            let index = parseInt(urlParams.get('index'), 10) || 0; // Default to 0
            let packData; // This will hold our pack data
            
            // Get all files from data.js
            const allFiles = (typeof myFiles !== 'undefined') ? myFiles : [];

            // 2. Check if the external data loaded. If not, use placeholder data.
            if (typeof evidencePacks === 'undefined' || evidencePacks.length === 0) {
                // Show an error banner
                const banner = document.getElementById('error-banner');
                if (banner) { 
                    banner.style.display = 'block';
                    banner.textContent = "Warning: 'evidencepackdata.js' not found or is empty. Displaying placeholder data.";
                }
                console.warn("Could not load 'evidencepackdata.js'. Using placeholder data.");

                // Manually define 'placeholder' data
                packData = {
                    "id": 0,
                    "title": "Placeholder: Self-Evaluation with Middle Leaders",
                    "primary_qi": "1.3 Leadership of Change",
                    "secondary_qi": "2.3 Learning, Teaching & Assessment",
                    "hgios_score": 4, // Set a default score
                    "tags": ["Placeholder"],
                    "what_text": "This is **placeholder text**.\n\nYour *'What: Our Practice'* description will appear here once you run the VBA macro from your Excel file and refresh this page.",
                    "participation_summary": [
                        "100% of departments...",
                        "100% of departments have taken part...",
                        "Six departments have formed...",
                        "All focus groups..."
                    ],
                    "so_what_text": "This is placeholder text.\nYour 'So What: Impact' summary will appear here.",
                    "impact_summary": [
                        "+15% increase in pupils...",
                        "8/10 departments closed...",
                        "100% of Department Plans..."
                    ],
                    "qualitative_summary": [
                        "“This is a **placeholder quote**.\n\nYour *qualitative summary* will appear here.”",
                        "“We have benefited greatly from speaking to colleagues...”"
                    ],
                    "what_now_steps": "This is a placeholder.\n\n* Next step 1.\n* Next step 2."
                };
            } else {
                // 3. Try to get the real data from the loaded file
                if (index < 0 || index >= evidencePacks.length) {
                    index = 0; // Fallback for invalid index
                }
                packData = evidencePacks[index];
            }
            
            // 4. Populate the page (this block runs for both real and placeholder data)
            try {
                document.title = packData.title;
                document.getElementById('pack-title').textContent = packData.title;
                
                // Use the helper function to set text or hide
                setTextOrHide(document.getElementById('primary-qi'), packData.primary_qi);
                setTextOrHide(document.getElementById('secondary-qi'), packData.secondary_qi);
                
                // HGIOS Meter
                const score = parseInt(packData.hgios_score, 10);
                document.getElementById('hgios-rating-text').textContent = `Self-Evaluation: ${score} - ${hgiosText[score]}`;
                document.getElementById('hgios-meter').innerHTML = buildHgiosMeter(score);
                
                // --- NEW: Populate Visual Evidence ---
                populateVisualEvidence(packData.title, allFiles);

                // "What" Section
                formatAndSetText('what-text', packData.what_text);
                document.getElementById('participation-grid').innerHTML = buildHtmlList(packData.participation_summary, 'quant-box');
                
                // "So What" Section
                formatAndSetText('so-what-text', packData.so_what_text);
                document.getElementById('impact-grid').innerHTML = buildHtmlList(packData.impact_summary, 'impact-box');
                document.getElementById('qualitative-bubbles').innerHTML = buildHtmlList(packData.qualitative_summary, 'speech-bubble');

                // "What Now" Section
                formatAndSetText('what-now-text', packData.what_now_steps);
                
                // --- Populate the evidence table ---
                populateEvidenceTable(packData.title, allFiles);

            } catch (error) {
                // This catch block will now handle errors during the *population* phase
                console.error("Failed to populate evidence pack:", error);
                document.getElementById('pack-title').textContent = "Error: Could not populate Evidence Pack.";
                const container = document.querySelector('.container');
                container.innerHTML = `<h1>Error</h1><p>Could not populate page from data.</p><p><strong>Details:</strong> ${error.message}</p>`;
            }
        };

    </script>
</body>
</html>